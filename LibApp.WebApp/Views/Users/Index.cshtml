@using Microsoft.AspNetCore.Identity
@using Domain.Models
@using LibApp.WebApp.ViewModels
@using X.PagedList
@using X.PagedList.Mvc.Core

@inject UserManager<User> UserManager

@{
    ViewData["Title"] = "Index";

    var user = await UserManager.GetUserAsync(User);

    IPagedList<UserViewModel>? userPages = ViewBag.Users as IPagedList<UserViewModel>;

    var svgSortNameAsc = @"<svg xmlns=""http://www.w3.org/2000/svg"" width=""16"" height=""16"" fill=""currentColor"" class=""bi bi-sort-alpha-down"" viewBox=""0 0 16 16""><path fill-rule=""evenodd"" d=""M10.082 5.629 9.664 7H8.598l1.789-5.332h1.234L13.402 7h-1.12l-.419-1.371zm1.57-.785L11 2.687h-.047l-.652 2.157z""/><path d=""M12.96 14H9.028v-.691l2.579-3.72v-.054H9.098v-.867h3.785v.691l-2.567 3.72v.054h2.645zM4.5 2.5a.5.5 0 0 0-1 0v9.793l-1.146-1.147a.5.5 0 0 0-.708.708l2 1.999.007.007a.497.497 0 0 0 .7-.006l2-2a.5.5 0 0 0-.707-.708L4.5 12.293z""/></svg>";
    var svgSortNameDesc = @"<svg xmlns=""http://www.w3.org/2000/svg"" width=""16"" height=""16"" fill=""currentColor"" class=""bi bi-sort-alpha-down-alt"" viewBox=""0 0 16 16""><path d=""M12.96 7H9.028v-.691l2.579-3.72v-.054H9.098v-.867h3.785v.691l-2.567 3.72v.054h2.645z""/><path fill-rule=""evenodd"" d=""M10.082 12.629 9.664 14H8.598l1.789-5.332h1.234L13.402 14h-1.12l-.419-1.371zm1.57-.785L11 9.688h-.047l-.652 2.156z""/><path d=""M4.5 2.5a.5.5 0 0 0-1 0v9.793l-1.146-1.147a.5.5 0 0 0-.708.708l2 1.999.007.007a.497.497 0 0 0 .7-.006l2-2a.5.5 0 0 0-.707-.708L4.5 12.293z""/></svg>";

}

@* TODO: Links to users *@

<h1>Index</h1>

<p>
    <a asp-action="Create">Create New</a>
</p>

<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-funnel-fill" viewBox="0 0 16 16">
    <path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.342.474l-3 1A.5.5 0 0 1 6 14.5V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5z"></path>
</svg>

@using (Html.BeginForm("Index", "Users", FormMethod.Get))
{
    <p>
        Find by fullname, username or email:
        <br />
        @Html.TextBox("SearchNameString", ViewBag.CurrentNameFilter as string)
        <br /><br />

        Find by role:
        <br />
        @Html.DropDownList("RoleId", ViewBag.Roles as SelectList, "All", new { @class = "form-control", id = "RoleId", style = "width:200px;" })
        <br /><br />

        <input type="submit" value="Search" />

        <button type="button" onclick="clearInputs()">Clear</button>
    </p>
}

<table class="table">
    <thead>
    <tr>
        <th>
            Name
            <a href="@Url.Action("Index", 
                         new { sortNameOrder = ViewBag.SortNameParm, currentNameFilter = ViewBag.CurrentNameFilter, roleId = ViewBag.CurrentRoleId })">
                        
                @if (ViewBag.CurrentSortName == "name_desc")
                {
                    @Html.Raw(svgSortNameDesc)
                }
                else
                {
                    @Html.Raw(svgSortNameAsc)
                }
            </a>
        </th>

        <th>UserName</th>

        <th>Email</th>
            
        <th>Role</th>
            
        <th>City</th>
            
        <th>IsActive</th>
            
        <th>Created</th>
                    
        <th>Modified</th>
                    
        <th>CreatedBy</th>
                    
        <th>ModifiedBy</th>

        <th></th>
    </tr>
    </thead>
    <tbody>
    @foreach (var item in userPages) {
        <tr>
            <td>
                @Html.DisplayFor(modelItem => item.FullName)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.UserName)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Email)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Role)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.City)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.IsActive)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.CreatedDateTime)
            </td>
            <td>
                <a href="@Url.Action("Details", "Users", new { id = item.CreatedByUserId })">
                    @item.CreatedByUser
                </a>
            </td>
            <td>
                <a href="@Url.Action("Details", "Users", new { id = item.ModifiedByUserId })">
                    @item.ModifiedByUser
                </a>
            </td>

            <td>
                <a asp-action="Edit" asp-route-id="@item.Id">Edit</a> |
                <a asp-action="Details" asp-route-id="@item.Id">Details</a> |
                
                @if (user?.RoleId == (int)RoleEnum.Admin)
                {
                    <a class="delete-button" 
                       data-controller="Users" 
                       data-action="Delete" 
                       data-id="@item.Id" 
                       style="color: #51cbce; text-decoration: none; cursor: pointer;"
                       onmouseover="this.style.textDecoration='underline';"
                       onmouseout="this.style.textDecoration='none';">Delete</a>
                }
            </td>
        </tr>
    }
    </tbody>

</table>

<br />
    
Page @(userPages.PageNumber) of @(userPages.PageCount)

@Html.PagedListPager(userPages, page => Url.Action("Index",
        new { page, sortNameOrder = ViewBag.CurrentSortName, currentNameFilter = ViewBag.CurrentNameFilter, roleId = ViewBag.CurrentRoleId }))
